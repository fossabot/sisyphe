<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Dispatcher.html">Dispatcher</a><ul class='methods'><li data-type='method'><a href="Dispatcher.html#.addPatient">addPatient</a></li><li data-type='method'><a href="Dispatcher.html#.addToWaitingQueue">addToWaitingQueue</a></li><li data-type='method'><a href="Dispatcher.html#.cleanDead">cleanDead</a></li><li data-type='method'><a href="Dispatcher.html#.exitFunction">exitFunction</a></li><li data-type='method'><a href="Dispatcher.html#.getPatient">getPatient</a></li><li data-type='method'><a href="Dispatcher.html#.init">init</a></li><li data-type='method'><a href="Dispatcher.html#.recreateFork">recreateFork</a></li><li data-type='method'><a href="Dispatcher.html#.start">start</a></li></ul></li><li><a href="Manufactory.html">Manufactory</a><ul class='methods'><li data-type='method'><a href="Manufactory.html#.bindDispatchers">bindDispatchers</a></li><li data-type='method'><a href="Manufactory.html#.createDispatchers">createDispatchers</a></li><li data-type='method'><a href="Manufactory.html#.createOverseersForDispatchers">createOverseersForDispatchers</a></li><li data-type='method'><a href="Manufactory.html#.final">final</a></li><li data-type='method'><a href="Manufactory.html#.init">init</a></li><li data-type='method'><a href="Manufactory.html#.initializeWorkers">initializeWorkers</a></li><li data-type='method'><a href="Manufactory.html#.start">start</a></li></ul></li><li><a href="monitoring.html">monitoring</a><ul class='methods'><li data-type='method'><a href="monitoring.html#.updateLog">updateLog</a></li></ul></li><li><a href="Overseer.html">Overseer</a><ul class='methods'><li data-type='method'><a href="Overseer.html#.final">final</a></li><li data-type='method'><a href="Overseer.html#.init">init</a></li><li data-type='method'><a href="Overseer.html#.send">send</a></li></ul></li><li><a href="sisyphe.html">sisyphe</a><ul class='methods'><li data-type='method'><a href="sisyphe.html#.init">init</a></li><li data-type='method'><a href="sisyphe.html#.launch">launch</a></li></ul></li><li><a href="Task.html">Task</a><ul class='methods'><li data-type='method'><a href="Task.html#.add">add</a></li><li data-type='method'><a href="Task.html#.getJobCounts">getJobCounts</a></li><li data-type='method'><a href="Task.html#.init">init</a></li><li data-type='method'><a href="Task.html#.on">on</a></li><li data-type='method'><a href="Task.html#.process">process</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">app</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>#!/usr/bin/env node

const bluebird = require('bluebird');
const program = require('commander');
const pkg = require('./package.json');
const path = require('path');
const Manufactory = require('./src/manufactory');
const monitoring = require('./src/monitoring');
const numCPUs = require('os').cpus().length;
const redis = require('redis');
bluebird.promisifyAll(redis.RedisClient.prototype);
bluebird.promisifyAll(redis.Multi.prototype);
const client = redis.createClient();
program
  .version(pkg.version)
  .usage('[options] &lt;path>')
  .option('-n, --corpusname &lt;name>', 'Corpus name', 'default')
  .option('-c, --config-dir &lt;path>', 'Configuration folder path', 'none')
  .option('-s, --silent', 'Silence output', false)
  .parse(process.argv);

// Corpusname is default, we stop here
if (program.corpusname === 'default' || program.configDir === 'none') {
  program.outputHelp();
  process.exit(0);
}

const argPath = program.args[0];
const inputPath = argPath.charAt(0) === '/' ? argPath : path.join(__dirname, argPath);
const configDirOpt = program.configDir;
const configDir = configDirOpt.charAt(0) === '/' ? configDirOpt : path.join(__dirname, configDirOpt);
const silent = program.silent;
const now = Date.now();
const options = {
  corpusname: program.corpusname,
  configDir,
  inputPath,
  numCPUs,
  now
};


/**
 * Sisyphe is a generic NodeJS recursive folder analyser terminal application &amp; a (lerna) git monorepo.
 * @constructor
 */
const sisyphe = {};



/**
 * Init sisyphe. It flush redis, create all workers and initialize the monitoring
 * @param  {String[]} workers A list of workers (modules)
 * @return {Promise}         Empty Promise when initiation completes
 */
sisyphe.init = async function (workers) {
  this.workers = workers;
  await client.flushallAsync();
  await client.hmsetAsync('monitoring', 'start', Date.now(), 'workers', JSON.stringify(workers));
  this.enterprise = Object.create(Manufactory);
  this.enterprise.init(options);
  this.workers.map(worker => {
    this.enterprise.addWorker(worker);
  });
  await this.enterprise.initializeWorkers();
  await monitoring.updateLog('info', 'Initialisation OK');
  if (!silent) console.log('┌ All workers have been initialized');
};


/**
 * It launch sisyphe manage worker and catch all errors from the application to debug
 *
 * @return {type}  description
 */
sisyphe.launch = async function () {
  this.enterprise.dispatchers.map(dispatcher => {
    let i = 0;
    dispatcher.on('result', msg => {
      if (!silent) {
        i++;
        process.stdout.clearLine();
        process.stdout.cursorTo(0);
        process.stdout.write('├──── ' + dispatcher.patients[0].workerType + ' ==> ' + i.toString());
      }
    });
    dispatcher.on('stop', async patients => {
      const currentWorker = patients[0].workerType;
      const lastWorker = this.workers[this.workers.length - 1];
      if (!silent) process.stdout.write(' ==> ' + currentWorker + ' has finished\n');
      await monitoring.updateLog('info', currentWorker + ' has finished');
      for (var i = 0; i &lt; patients.length; i++) {
        var patient = patients[i];
        if (!patient.signalCode==='SIGSEGV') {
          await patient.final().catch(err=>err)
        }
      }
      patients.map(patient => { // clean forks when finalJob is ending
        patient.fork.kill('SIGTERM');
      });
      if (currentWorker === lastWorker) {
        if (!silent) console.log('└ All workers have completed their work');
        await monitoring.updateLog('info', 'All workers have completed their work');
        await client.hmsetAsync('monitoring', 'end', Date.now());
        process.exit(0);
      }
    });
    dispatcher.on('error', async error => {
      console.log(error)
      monitoring.updateLog('error', error);
    });
  });
  await this.enterprise.start();
};

sisyphe.init(['walker-fs', 'filetype', 'pdf', 'xml', 'xpath', 'out']).then(() => {
  return sisyphe.launch();
}).catch(err => {
  monitoring.updateLog('error', err);
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Wed Sep 06 2017 11:15:16 GMT+0200 (CEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
